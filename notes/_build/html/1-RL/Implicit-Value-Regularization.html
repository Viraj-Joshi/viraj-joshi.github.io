
<!DOCTYPE html>


<html lang="en" data-content_root="../" data-theme="light">

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Implicit Value Regularization (IVR) &#8212; some technical notes</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "light";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css?v=6644e6bb" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-design.min.css?v=95c83b7e" />
    <link rel="stylesheet" type="text/css" href="../_static/custom.css?v=25df36a0" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../_static/doctools.js?v=9bcbadda"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '1-RL/Implicit-Value-Regularization';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Score Matching" href="../2-diffusion-models/Score-Matching.html" />
    <link rel="prev" title="some technical perusings" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="light">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">some technical notes</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Reinforcement Learning</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Implicit Value Regularization (IVR)</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Diffusion Models</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../2-diffusion-models/Score-Matching.html">Score Matching</a></li>


</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://colab.research.google.com/github/kvfrans/notes/blob/master/1-RL/Implicit-Value-Regularization.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch on Colab"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="Colab logo" src="../_static/images/logo_colab.png">
  </span>
<span class="btn__text-container">Colab</span>
</a>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Implicit Value Regularization (IVR)</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-is-offline-rl-hard">Why is Offline RL hard?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-we-solve-for-an-optimal-policy-using-solely-in-sample-learning">Can we solve for an optimal policy using solely in-sample learning?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-a-behavior-regularized-mdp">Solving a behavior-regularized MDP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-form-of-pi">Finding the form of <span class="math notranslate nohighlight">\(\pi^*\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-u">Finding U*</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-v">Finding V*</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theorem-1">Theorem 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-a-practical-algorithm">Instantiating a practical algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sparse-q-learning">Sparse Q-Learning</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="implicit-value-regularization-ivr">
<h1>Implicit Value Regularization (IVR)<a class="headerlink" href="#implicit-value-regularization-ivr" title="Link to this heading">#</a></h1>
<section id="why-is-offline-rl-hard">
<h2>Why is Offline RL hard?<a class="headerlink" href="#why-is-offline-rl-hard" title="Link to this heading">#</a></h2>
</section>
<section id="can-we-solve-for-an-optimal-policy-using-solely-in-sample-learning">
<h2>Can we solve for an optimal policy using solely in-sample learning?<a class="headerlink" href="#can-we-solve-for-an-optimal-policy-using-solely-in-sample-learning" title="Link to this heading">#</a></h2>
</section>
<section id="solving-a-behavior-regularized-mdp">
<h2>Solving a behavior-regularized MDP<a class="headerlink" href="#solving-a-behavior-regularized-mdp" title="Link to this heading">#</a></h2>
<p>We can directly solve for optimal policy <span class="math notranslate nohighlight">\(\pi^*\)</span> in the class of MDPs where an f-divergence is added to the reward at each timestep and a reference policy <span class="math notranslate nohighlight">\(\mu\)</span> is given</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
&amp; \max_{\pi} \mathbb{E}_{\tau \sim \pi}[r(\tau)] - \alpha D_{f}(\pi \| \mu) \\
&amp; \equiv \max_{\pi} \mathbb{E}_{\tau \sim \pi} \left[ \sum_{t=0}^{\infty} \gamma^t \left( r(s_t, a_t) - \alpha \cdot f \left( \frac{\pi(a_t|s_t)}{\mu(a_t|s_t)} \right) \right) \right] \\
&amp; \equiv \max_{\pi} \mathbb{E}_{s \sim d^\pi}[V(s)] \\
&amp; \equiv \max_{\pi} \mathbb{E}_{s \sim d^{\pi}, a \sim \pi(\cdot|s)}\left[Q(s,a) - \alpha \cdot f\left(\frac{\pi(a|s)}{\mu(a|s)}\right)\right] \\
\end{align}
\end{split}\]</div>
<p>There are only two types of constraints in this optimization, constraining <span class="math notranslate nohighlight">\(\pi\)</span> to be a valid probability distribution</p>
<ol class="arabic simple">
<li><p><span class="math notranslate nohighlight">\(\sum_a \pi(a\|s)=1 \quad \forall s\)</span></p></li>
<li><p><span class="math notranslate nohighlight">\(\pi(a\|s) \geq 0 \quad \forall a,s\)</span></p></li>
</ol>
<p>We write the Langrangian with dual variables <span class="math notranslate nohighlight">\(u(s)\)</span> for the first constraints and <span class="math notranslate nohighlight">\(\beta(a\|s)\)</span> for the second constraints</p>
<div class="math notranslate nohighlight">
\[L(\pi, \beta, u) = \underbrace{\sum_s d^{\pi}(s) \sum_a \pi(a|s) \left(Q(s,a) - \alpha f\left(\frac{\pi(a|s)}{\mu(a|s)}\right)\right)}_{J(\pi)} - \sum_s d^{\pi}(s) \bigg[ \underbrace{u(s) \bigg(\sum_a \pi(a|s) - 1\bigg)}_{=0} - \underbrace{\sum_a \beta(a|s) \pi(a|s)}_{\geq 0}\bigg]\]</div>
<p>In a primal maximization problem, the lagrangian should be a upper bound, given feasible (<span class="math notranslate nohighlight">\(\pi,\beta,u\)</span>), on the primal optimal solution. This is why the constraints are subtracted because at feasibility they add to the objective and any violation will decrease the objective. This is apparent when we write the relation where <span class="math notranslate nohighlight">\(C\)</span> is the feasible set:</p>
<div class="math notranslate nohighlight">
\[ J(\pi^*) \leq \max_{\pi \in C} L(\pi, \beta, u) \leq \max_\pi L(\pi, \beta, u) := g(\beta,u)\]</div>
<p>Instead of minimizing the dual function <span class="math notranslate nohighlight">\(g(\beta,u)\)</span> (which is actually a convex problem!), we can use the KKT conditions to derive the optimal solution. Famously, the four KKT conditions describe that if strong duality holds and we find a tuple <span class="math notranslate nohighlight">\((\pi,\beta,u)\)</span> that satisfy these conditions, then <span class="math notranslate nohighlight">\(\pi\)</span> is primal optimal and <span class="math notranslate nohighlight">\((\beta, u)\)</span> is dual optimal. They are,</p>
<p>Primal feasibility: <span class="math notranslate nohighlight">\(0 \leq \pi(a\|s) \leq 1 \quad \forall a,s \text{ and } \pi(a\|s) \geq 0 \quad \forall a,s\)</span></p>
<p>Dual Feasibility: <span class="math notranslate nohighlight">\(u \text{ is unconstrained}, \beta(a\|s) \geq 0 \quad \forall a,s\)</span></p>
<p>Complementary Slackness: <span class="math notranslate nohighlight">\(\beta(a\|s) \cdot \pi(a\|s) = 0 \quad \forall a,s\)</span></p>
<p>Stationarity: <span class="math notranslate nohighlight">\(\frac{\partial L}{\partial \pi(a\|s)} = 0\)</span></p>
<div class="math notranslate nohighlight">
\[\frac{\partial}{\partial \pi(a|s)} \left[ \sum_{s'} d^{\pi}(s') \cdot (\text{local objective at } s') \right]\]</div>
<p>Notice that this will involve the product rule on every term in the summation.</p>
<p><span class="math notranslate nohighlight">\(d^\pi\)</span> is dependent on <span class="math notranslate nohighlight">\(\pi\)</span> in that changing the policy at state <span class="math notranslate nohighlight">\(s\)</span> affects the visit frequency of all other states <span class="math notranslate nohighlight">\(s'\)</span> i.e the stationary distribution of the entire system changes.</p>
<p>To see this, let’s define the “local objective” at state <span class="math notranslate nohighlight">\(s'\)</span> as <span class="math notranslate nohighlight">\(J(s', \pi)\)</span>:</p>
<div class="math notranslate nohighlight">
\[J(s', \pi) = \left[ \sum_{a'} \pi(a'|s') \left(Q(s',a') - \alpha f\left(\frac{\pi(a'|s')}{\mu(a'|s')}\right)\right) - u(s') \left(\sum_{a'} \pi(a'|s') - 1\right) + \dots \right]\]</div>
<p>The stationary condition can be restated as</p>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial \pi(a|s)} = \frac{\partial}{\partial \pi(a|s)} \left[ \sum_{s'} d^{\pi}(s') \cdot J(s', \pi) \right] = 0\]</div>
<p>Applying the product rule to each term <span class="math notranslate nohighlight">\(s'\)</span>:</p>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial \pi(a|s)} = \sum_{s'} \left[ \underbrace{\left( \frac{\partial d^{\pi}(s')}{\partial \pi(a|s)} \right) \cdot J(s', \pi)}_{\text{Term 1: Global Impact}} + \underbrace{d^{\pi}(s') \cdot \left( \frac{\partial J(s', \pi)}{\partial \pi(a|s)} \right)}_{\text{Term 2: Local Impact}} \right] = 0\]</div>
<p>If we treat <span class="math notranslate nohighlight">\(\frac{\partial d^{\pi}(s')}{\partial \pi(a\|s)}\)</span> as a constant, then Term 1 goes to zero.</p>
<p>Term 2 collapses to just one term (where <span class="math notranslate nohighlight">\(s' = s\)</span>) because the partial derivative of <span class="math notranslate nohighlight">\(J(s',\pi)\)</span> with respect to <span class="math notranslate nohighlight">\(\pi(a\|s)\)</span> is zero unless <span class="math notranslate nohighlight">\(s' = s\)</span></p>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial \pi(a|s)} = d^\pi(s) \cdot \frac{ \partial J(s, \pi)}{\partial \pi(a|s)} \]</div>
<p>Then, we also assume <span class="math notranslate nohighlight">\(d^\pi\)</span> is an irreducible Markov chain (it’s possible to get from any state to any other state, but not necessarily in one step, so <span class="math notranslate nohighlight">\(d^\pi &gt; 0 \quad \forall s\)</span>), so we can divide both sides of the equation to get rid of <span class="math notranslate nohighlight">\(d^\pi\)</span>.</p>
<div class="math notranslate nohighlight">
\[\frac{\partial L}{\partial \pi(a|s)} = \frac{ \partial J(s, \pi)}{\partial \pi(a|s)} = 0\]</div>
<p>We break down <span class="math notranslate nohighlight">\(\partial J(s,\pi)\)</span> term by term.</p>
<div class="math notranslate nohighlight">
\[ \frac{\partial}{\partial \pi(a|s)} \left[ \sum_{a'} \pi(a'|s) Q(s,a') \right] = Q(s,a)\]</div>
<hr class="docutils" />
<div class="math notranslate nohighlight">
\[\begin{split}
\begin{align}
 &amp; \frac{\partial}{\partial \pi(a|s)} \left[-\alpha \sum_{a'} \pi(a'|s) f\left(\frac{\pi(a'|s)}{\mu(a'|s)}\right)\right]\\
 
 &amp;=-\alpha \left[ \frac{\partial \pi(a|s)}{\partial \pi(a|s)} \cdot f\left(\frac{\pi(a|s)}{\mu(a|s)}\right) + \pi(a|s) \cdot \frac{\partial f(\frac{\pi(a|s)}{\mu(a|s)})}{\partial \pi(a|s)} \right]\\
 
 &amp;= -\alpha \cdot \underbrace{
    \left(f\left(\frac{\pi(a|s)}{\mu(a|s)}\right) + \frac{\pi(a|s)}{\mu(a|s)}f'\left(\frac{\pi(a|s)}{\mu(a|s)}\right)\right)
  }_{h'(x) = x \cdot f(x) \text{ where } x = \frac{\pi}{\mu}} \\
&amp; = -\alpha \cdot h'_f(\frac{\pi(a|s)}{\mu(a|s)})
\end{align}
\end{split}\]</div>
<hr class="docutils" />
<div class="math notranslate nohighlight">
\[\frac{\partial}{\partial \pi(a|s)} \left[ -u(s) \left(\sum_{a'} \pi(a'|s) - 1\right) \right] = -u(s)\]</div>
<hr class="docutils" />
<div class="math notranslate nohighlight">
\[\frac{\partial}{\partial \pi(a|s)} \left[ \sum_{a'} \beta(a'|s) \pi(a'|s) \right] = \beta(a|s)\]</div>
<hr class="docutils" />
<p>Summing the terms, we get</p>
<div class="math notranslate nohighlight">
\[Q(s,a) - \alpha h'_f\left(\frac{\pi(a|s)}{\mu(a|s)}\right) - u(s) + \beta(a|s) = 0\]</div>
<section id="finding-the-form-of-pi">
<h3>Finding the form of <span class="math notranslate nohighlight">\(\pi^*\)</span><a class="headerlink" href="#finding-the-form-of-pi" title="Link to this heading">#</a></h3>
<p>We rearrange the stationarity condition to obtain:</p>
<div class="math notranslate nohighlight">
\[\pi(a|s) = \mu(a|s) \cdot g_f\left( \frac{1}{\alpha} \left( Q(s,a) - u(s) + \beta(a|s) \right) \right)\]</div>
<p>where <span class="math notranslate nohighlight">\(g_f\)</span> is the inverse of <span class="math notranslate nohighlight">\(h'\)</span>.</p>
<p>We can eliminate one of the dual variables <span class="math notranslate nohighlight">\(\beta\)</span> by leveraging complementary slackness.</p>
<p>The complementary slackness condition, <span class="math notranslate nohighlight">\(\beta(a\|s) \cdot \pi(a\|s) = 0\)</span>, creates two distinct cases for any action a</p>
<p>Case A (Action is taken, <span class="math notranslate nohighlight">\(\pi(a\|s) &gt; 0\)</span>): This forces <span class="math notranslate nohighlight">\(\beta(a\|s) = 0\)</span>.</p>
<p>Case B (Action is ignored, <span class="math notranslate nohighlight">\(\pi(a\|s) = 0\)</span>): This implies that the argument of <span class="math notranslate nohighlight">\(g_f\)</span> (when <span class="math notranslate nohighlight">\(\beta(a\|s)=0\)</span>) must be non-positive.</p>
<p>The max function captures this: it selects the calculated probability if it’s positive (Case A) and selects 0 if it’s negative (Case B).</p>
<div class="math notranslate nohighlight">
\[\pi(a|s) = \mu(a|s) \cdot \max\left\{ g_f\left( \frac{1}{\alpha} (Q(s,a) - u(s)) \right), 0 \right\}\]</div>
</section>
<section id="finding-u">
<h3>Finding U*<a class="headerlink" href="#finding-u" title="Link to this heading">#</a></h3>
<p>The optimal dual variable <span class="math notranslate nohighlight">\(U*\)</span> is found by first substituting the optimal policy into the primal feasibility constraint.</p>
<div class="math notranslate nohighlight">
\[\sum_a \left[ \mu(a|s) \cdot \max\left\{ g_f\left( \frac{1}{\alpha} (Q(s,a) - u(s)) \right), 0 \right\} \right]
 = \mathbb E_{a\sim\mu} \left[ \max\left\{ g_f\left( \frac{1}{\alpha} (Q(s,a) - u(s)) \right), 0 \right\} \right] = 1\]</div>
<p>This is a one-dimensional equation in <span class="math notranslate nohighlight">\(u(s)\)</span>. We solve this equation for <span class="math notranslate nohighlight">\(u(s)\)</span>. We will see exactly how to recover this for specific choices <span class="math notranslate nohighlight">\(f\)</span> in the next section.</p>
</section>
<section id="finding-v">
<h3>Finding V*<a class="headerlink" href="#finding-v" title="Link to this heading">#</a></h3>
<p>Once this optimal policy form <span class="math notranslate nohighlight">\(\pi^* \)</span> is found by solving for the unique Lagrange multiplier <span class="math notranslate nohighlight">\(u^* (s)\)</span> (which enforces the normalization <span class="math notranslate nohighlight">\(\sum_a \pi^* (a\|s) = 1\)</span>), we can derive the optimal state value <span class="math notranslate nohighlight">\(V^* (s)\)</span>.
The optimal policy corresponds to the optimal state value</p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align}
    V^* (s) &amp;= \sum_a \pi^* (a|s) \left( Q^* (s,a) - \alpha f\left(\frac{\pi^* (a|s)}{\mu(a|s)}\right) \right)\\
    \end{align}
\end{split}\]</div>
<p>At optimality, the primal optimum (<span class="math notranslate nohighlight">\(\pi^* \)</span>) and dual optimum (<span class="math notranslate nohighlight">\( u^* \)</span>,<span class="math notranslate nohighlight">\( \beta^* \)</span>) solution satisfy the KKT conditions. We can simplify the stationarity condition using complementary slackness, where for any action where <span class="math notranslate nohighlight">\(\pi^* (a\|s) &gt; 0\)</span>, we have <span class="math notranslate nohighlight">\(\beta(a\|s) = 0\)</span>, which gives</p>
<div class="math notranslate nohighlight">
\[Q^* (s,a) = u^* (s) + \alpha h'_f\left(\frac{\pi^* (a|s)}{\mu(a|s)}\right)\]</div>
<p>Substitute the definition of <span class="math notranslate nohighlight">\(h_f^{`}\)</span> into <span class="math notranslate nohighlight">\(Q^* (s,a)\)</span>.</p>
<div class="math notranslate nohighlight">
\[Q^*(s,a) = u^*(s) + \alpha \left[ f\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) + \frac{\pi^*(a|s)}{\mu(a|s)} f'\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) \right]\]</div>
<p>Substitute <span class="math notranslate nohighlight">\(Q^* \)</span> back into <span class="math notranslate nohighlight">\( V^* \)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
    \begin{align}
        V^*(s) &amp;= \sum_a \pi^*(a|s) \left( \left[ u^*(s) + \alpha f(\dots) + \alpha \frac{\pi^* (a|s)}{\mu(a|s)} f'(\dots) \right] - \alpha f(\dots) \right) \\
        &amp;= \sum_a \pi^*(a|s) \left( u^*(s) + \alpha \frac{\pi^*(a|s)}{\mu(a|s)} f'\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) \right)\\
        &amp;= \sum_a \pi^*(a|s) u^*(s) + \sum_a \pi^*(a|s) \left( \alpha \frac{\pi^*(a|s)}{\mu(a|s)} f'(\dots) \right)  \\
        &amp;= u^*(s) \sum_a \pi^*(a|s) + \alpha \sum_a \frac{\pi^*(a|s)^2}{\mu(a|s)} f'(\dots) \\
        &amp;= u^*(s) + \alpha \sum_a \mu(a|s) \left[ \left(\frac{\pi^*(a|s)}{\mu(a|s)}\right)^2 f'\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) \right]\\
        &amp; = u^*(s) + \alpha \mathbb{E}_{a \sim \mu} \left[ \left(\frac{\pi^*(a|s)}{\mu(a|s)}\right)^2 f'\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) \right]
    \end{align}
\end{split}\]</div>
</section>
</section>
<section id="theorem-1">
<h2>Theorem 1<a class="headerlink" href="#theorem-1" title="Link to this heading">#</a></h2>
<p>In the behavior-regularized MDP, we have the following for any state and action</p>
<div class="math notranslate nohighlight">
\[Q^* (s,a) = r(s,a) + E_{s'\sim T(\cdot,s,a)} [V^* (s')]\]</div>
<div class="math notranslate nohighlight">
\[\pi^* (a|s) = \mu(a|s) \cdot \max\left\{ g_f\left( \frac{1}{\alpha} (Q^* (s,a) - u^* (s)) \right), 0 \right\}\]</div>
<div class="math notranslate nohighlight">
\[V^* (s)= u^*(s) + \alpha \mathbb{E}_{a \sim \mu} \left[ \left(\frac{\pi^*(a|s)}{\mu(a|s)}\right)^2 f'\left(\frac{\pi^*(a|s)}{\mu(a|s)}\right) \right]\]</div>
<p>where <span class="math notranslate nohighlight">\(U^* (s)\)</span> ensures <span class="math notranslate nohighlight">\(\sum_a \pi^* (a\|s)=1\)</span></p>
</section>
<section id="instantiating-a-practical-algorithm">
<h2>Instantiating a practical algorithm<a class="headerlink" href="#instantiating-a-practical-algorithm" title="Link to this heading">#</a></h2>
<p>In offline RL, in order to completely avoid out-of-distribution actions, we want a zero-forcing support constraint, that <span class="math notranslate nohighlight">\(\mu(a\|s)=0 \implies \pi(a\|s)=0\)</span>. This is given by <span class="math notranslate nohighlight">\(\alpha\)</span>-divergence, a subset of <span class="math notranslate nohighlight">\(f\)</span>-divergence, and takes the following form for <span class="math notranslate nohighlight">\(\alpha \in [0,1]\)</span></p>
<div class="math notranslate nohighlight">
\[D_\alpha(\mu,\pi) = \frac{1}{\alpha (\alpha-1)}\mathbb E_\pi \left[\left(\frac{\pi}{\mu}\right)^{-\alpha}-1\right]\]</div>
<p>Specifically, when <span class="math notranslate nohighlight">\(\alpha \leq 0\)</span>, the divergence will enforce this zero-forcing constraint or ‘mode-seeking’.</p>
</section>
<section id="sparse-q-learning">
<h2>Sparse Q-Learning<a class="headerlink" href="#sparse-q-learning" title="Link to this heading">#</a></h2>
<p><span class="math notranslate nohighlight">\(\alpha=-1\)</span> yields <span class="math notranslate nohighlight">\(\chi\)</span>-squared divergence, where
$<span class="math notranslate nohighlight">\(f(x) = x-1 \implies f'(x) = 1\)</span>$</p>
<p>And by definition:</p>
<div class="math notranslate nohighlight">
\[h'_f(x) = f(x) + xf'(x) = (x-1) + x(1) = 2x - 1\]</div>
<div class="math notranslate nohighlight">
\[g_f(y) = \frac{1}{2}y + \frac{1}{2}\]</div>
<p>With this we can define the relevant objects</p>
<ol class="arabic">
<li><p>Substitute <span class="math notranslate nohighlight">\(g_f(y)\)</span> into general policy form from Theorem 1:</p>
<div class="math notranslate nohighlight">
\[\pi^*(a|s) = \mu(a|s) \cdot \max\left\{ \frac{1}{2} + \frac{Q^*(s,a) - U^*(s)}{2\alpha}, 0 \right\}\]</div>
</li>
<li><p>The optimal Lagrange multiplier <span class="math notranslate nohighlight">\(U^* (s)\)</span> is the unique value such that <span class="math notranslate nohighlight">\(\pi^* \)</span>  satisfies the normalization constraint <span class="math notranslate nohighlight">\(\sum_a \pi^* (a\|s) = 1\)</span></p>
<div class="math notranslate nohighlight">
\[\mathbb{E}_{a \sim \mu} \left[ \max\left\{ \frac{1}{2} + \frac{Q^*(s,a) - U^*(s)}{2\alpha}, 0 \right\} \right] = 1\]</div>
</li>
<li><p>Substitute the derivative <span class="math notranslate nohighlight">\(f'(x) = 1\)</span> into general form for <span class="math notranslate nohighlight">\(V^*(s)\)</span> from Theorem 1:</p>
<div class="math notranslate nohighlight">
\[V^*(s) = U^*(s) + \alpha \mathbb{E}_{a \sim \mu} \left[ \left(\frac{\pi^*(a|s)}{\mu(a|s)}\right)^2 \right]\]</div>
</li>
</ol>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./1-RL"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">some technical perusings</p>
      </div>
    </a>
    <a class="right-next"
       href="../2-diffusion-models/Score-Matching.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Score Matching</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#why-is-offline-rl-hard">Why is Offline RL hard?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#can-we-solve-for-an-optimal-policy-using-solely-in-sample-learning">Can we solve for an optimal policy using solely in-sample learning?</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#solving-a-behavior-regularized-mdp">Solving a behavior-regularized MDP</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-the-form-of-pi">Finding the form of <span class="math notranslate nohighlight">\(\pi^*\)</span></a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-u">Finding U*</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#finding-v">Finding V*</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#theorem-1">Theorem 1</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#instantiating-a-practical-algorithm">Instantiating a practical algorithm</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#sparse-q-learning">Sparse Q-Learning</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Viraj Joshi
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>